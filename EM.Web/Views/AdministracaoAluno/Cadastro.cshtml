@model Aluno
@{
    var isEdicao = (ViewBag.IsEdicao as bool?) ?? false;
    ViewData["Title"] = isEdicao ? "Editar Aluno" : "Novo Aluno";
    var cidades = ViewBag.Cidades as IEnumerable<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>;
}

<div class="card shadow-sm">
    <div class="card-body">
        <div class="mb-4">
            <h1 class="h4 mb-1">@ViewData["Title"]</h1>
            <p class="text-muted mb-0">Preencha os dados do aluno abaixo</p>
        </div>

        <form method="post" class="row g-3" id="formAluno" novalidate>
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Id" />
            
            <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

            <div class="col-md-6">
                <label asp-for="Matricula" class="form-label">Matrícula <span class="text-danger">*</span></label>
                <input asp-for="Matricula" class="form-control" placeholder="Digite a matrícula" />
                <span asp-validation-for="Matricula" class="text-danger small"></span>
            </div>

            <div class="col-md-6">
                <label asp-for="NomeCompleto" class="form-label">Nome Completo <span class="text-danger">*</span></label>
                <input asp-for="NomeCompleto" class="form-control" placeholder="Digite o nome completo" />
                <span asp-validation-for="NomeCompleto" class="text-danger small"></span>
            </div>

            <div class="col-md-4">
                <label asp-for="CPF" class="form-label">CPF</label>
                <input asp-for="CPF" 
                       class="form-control" 
                       id="cpf" 
                       placeholder="000.000.000-00"
                       oninput="formatarCPF(this)" />
                <span asp-validation-for="CPF" class="text-danger small"></span>
            </div>

            <div class="col-md-4">
                <label asp-for="DataNascimento" class="form-label">Data de Nascimento <span class="text-danger">*</span></label>
                <input asp-for="DataNascimento" 
                       type="date" 
                       class="form-control" 
                       max="@DateTime.Now.ToString("yyyy-MM-dd")" />
                <span asp-validation-for="DataNascimento" class="text-danger small"></span>
            </div>

            <div class="col-md-4">
                <label asp-for="Genero" class="form-label">Sexo <span class="text-danger">*</span></label>
                <select asp-for="Genero" class="form-select">
                    <option value="1">Masculino</option>
                    <option value="2">Feminino</option>
                </select>
                <span asp-validation-for="Genero" class="text-danger small"></span>
            </div>

            <div class="col-md-12">
                <label asp-for="Residencia.Id" class="form-label">Cidade <span class="text-danger">*</span></label>
                <select asp-for="Residencia.Id" asp-items="cidades" class="form-select">
                    <option value="">Selecione uma cidade</option>
                </select>
                <span asp-validation-for="Residencia.Id" class="text-danger small"></span>
                <small class="text-muted">
                    Não encontrou a cidade? <a asp-controller="AdministracaoCidade" asp-action="Index">Gerenciar cidades</a>
                </small>
            </div>

            <div class="col-12 d-flex justify-content-between mt-4">
                <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary">Salvar</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        function formatarCPF(input) {
            let valor = input.value.replace(/\D/g, '');
            
            if (valor.length <= 11) {
                valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            }
            
            input.value = valor;
        }

        // Desabilitar validação JavaScript - permitir apenas validação do servidor
        document.addEventListener('DOMContentLoaded', function() {
            var form = document.getElementById('formAluno');
            
            // Desabilita validação HTML5 nativa
            if (form) {
                form.noValidate = true;
            }
            
            // Remove validação jQuery se existir
            if (typeof $ !== 'undefined') {
                $('#formAluno').removeData('validator');
                $('#formAluno').removeData('unobtrusiveValidation');
                $('#formAluno').off('submit.validate');
            }
            
            // Sincronizar select com valor do modelo se estiver editando ou se houver erro de validação
            var cidadeSelect = document.getElementById('Residencia_Id');
            var cidadeId = @(Model?.Residencia?.Id ?? 0);
            if (cidadeSelect && cidadeId > 0) {
                cidadeSelect.value = cidadeId;
                console.log('Cidade selecionada:', cidadeId);
            }
            
            // Log quando o select mudar
            if (cidadeSelect) {
                cidadeSelect.addEventListener('change', function() {
                    console.log('Cidade alterada para:', this.value);
                });
            }
        });
    </script>
}
